<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard RH</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .navbar-dark.bg-bordeaux { background-color: #6d071a !important; }
    .nav-tabs .nav-link { color: #6d071a !important; font-weight: 500; }
    .nav-tabs .nav-link.active { color: #fff !important; background-color: #6d071a !important; border-color: #6d071a #6d071a #fff; }
    table.table thead tr th { background-color: #6d071a !important; color: #fff !important; }
    .card { border: 1px solid #6d071a; border-radius: 0.5rem; }
    h1, h4 { color: #6d071a; }
    .btn-deconnexion { background-color: #fff; color: #6d071a; border: 2px solid #6d071a; font-weight: 500; }
    .btn-deconnexion:hover { background-color: #6d071a; color: #fff; }
  </style>
</head>
<body class="bg-light p-4">

<nav class="navbar navbar-expand-lg navbar-dark bg-bordeaux mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" th:href="@{/rh-dashboard}">Espace RH</a>
    <div class="d-flex ms-auto">
      <span class="navbar-text text-white me-3" th:text="${'Bonjour, ' + user.prenom}"></span>
      <a th:href="@{/logout}" class="btn btn-deconnexion"><i class="fas fa-right-from-bracket me-1"></i> Déconnexion</a>
    </div>
  </div>
</nav>

<div class="container">
  <ul class="nav nav-tabs mb-4" id="rhTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="employes-tab" data-bs-toggle="tab" data-bs-target="#employes" type="button">Gestion Employés</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="bulletins-tab" data-bs-toggle="tab" data-bs-target="#bulletins" type="button">Mon Espace Perso</button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- ONGLET 1 : LISTE DES EMPLOYÉS -->
    <div class="tab-pane fade show active" id="employes">
      <h1 class="text-center mb-4">Liste du personnel</h1>
      
      <div class="mb-4 text-end">
        <a th:href="@{/rh/hours}" class="btn btn-primary me-2">
            <i class="fas fa-clock me-1"></i> Saisir Heures
        </a>
        <a th:href="@{/rh/add}" class="btn btn-success">
            <i class="fas fa-user-plus me-1"></i> Ajouter un employé
        </a>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-body">
          <table class="table table-striped table-hover align-middle">
            <thead>
            <tr>
              <th>Matricule</th>
              <th>Nom</th>
              <th>Prénom</th>
              <th>Poste</th>
              <th>Date Emb.</th>
              <th>Taux</th>
              <th>Email</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="emp : ${employees}">
              <td th:text="${emp.matricule}"></td>
              <td th:text="${emp.nom}"></td>
              <td th:text="${emp.prenom}"></td>
              <td th:text="${emp.poste}"></td>
              <td th:text="${emp.dateEmbauche}"></td>
              <td th:text="${emp.tauxHoraire + ' €'}"></td>
              <td th:text="${emp.email}"></td>
              <td>
                <a th:href="@{/rh/edit/{id}(id=${emp.id})}" class="btn btn-info btn-sm me-1"><i class="fa-solid fa-pen-to-square"></i></a>
                <a th:href="@{/rh/delete/{id}(id=${emp.id})}" class="btn btn-danger btn-sm me-1" onclick="return confirm('Supprimer ?')"><i class="fa-solid fa-trash"></i></a>
                <a th:href="@{/rh-employe/{id}(id=${emp.id})}" class="btn btn-secondary btn-sm"><i class="fa-solid fa-eye"></i></a>
              </td>
            </tr>
            </tbody>
          </table>
          <p class="text-center text-muted mt-3" th:if="${#lists.isEmpty(employees)}">Aucun employé dans la base.</p>
        </div>
      </div>
    </div>

    <!-- ONGLET 2 : INFO PERSO DU RH -->
    <div class="tab-pane fade" id="bulletins">
      <h1 class="text-center mb-4">Mes Informations</h1>
      <div class="container">
        <div class="card shadow-sm p-4">
          <h4><i class="fas fa-address-card me-2"></i> Profil</h4>
          <hr>
          <p><strong>Matricule :</strong> <span th:text="${user.matricule}"></span></p>
          <p><strong>Nom :</strong> <span th:text="${user.nom}"></span></p>
          <p><strong>Prénom :</strong> <span th:text="${user.prenom}"></span></p>
          <p><strong>Poste :</strong> <span th:text="${user.poste}"></span></p>
          <p><strong>Email :</strong> <span th:text="${user.email}"></span></p>
        </div>

        <div class="card shadow-sm p-4 mt-4">
          <h4><i class="fa-solid fa-file-invoice me-2"></i> Mes bulletins de paie</h4>
          <hr>
          <table class="table table-striped align-middle" th:if="${!#lists.isEmpty(myPayslips)}">
            <thead><tr>
              <th>Période</th>
              <th>Salaire Net</th>
              <th>Télécharger</th></tr></thead>
            <tbody>
            <tr th:each="p : ${myPayslips}">
                <td th:text="${p.period}"></td>
                <td th:text="${p.totalSalary + ' €'}"></td>
                <td>
                  <!-- BOUTON CORRIGÉ & SÉCURISÉ -->
                  <button class="btn btn-sm btn-outline-primary"
                          th:if="${p.pdfPath != null}"
                          th:data-url="@{'/pdfs/' + ${#strings.substring(p.pdfPath, '/app/pdfs/'.length())}}"
                          onclick="openAndDownload(this.getAttribute('data-url'))">
                   <i class="fa-solid fa-download"></i>
                  </button>
                </td>
            </tr>
            </tbody>
          </table>
          <div th:if="${#lists.isEmpty(myPayslips)}" class="alert alert-info">Aucun bulletin disponible.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPT JS -->
<script>
function openAndDownload(url) {
    if (!url) return;
    // 1. Ouvre le PDF dans un nouvel onglet
    window.open(url, '_blank');

    // 2. Force le téléchargement
    const a = document.createElement('a');
    a.href = url;
    a.download = ''; 
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
</body>
</html>